<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendance Report</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #999;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    .present {
      background-color: #c8f7c5;
    }
    .absent {
      background-color: #f8d7da;
    }
    .low-attendance {
      background-color: #ffcccc; /* light red */
      font-weight: bold;
      color: red;
    }
    #TOTAL_ATTENDENCE {
      white-space: pre-line;
      font-weight: bold;
      margin-top: 15px;
    }
    #searchBar {
      width: 50%;
      padding: 8px;
      margin: 10px 0;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Attendance Report</h1>

  <label>Select Date: </label>
  <input type="date" id="reportDate" />

  <br><br>
  <input type="text" id="searchBar" placeholder="Search student by name..." />

  <table>
    <thead>
      <tr>
        <th>Student Name</th>
        <th>Daily Status (<span id="displayDate"></span>)</th>
        <th>Monthly % Attendance</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>

  <h2>TOTAL ATTENDENCE</h2>
  <p id="TOTAL_ATTENDENCE"></p>

  <script>
    const students = JSON.parse(localStorage.getItem("students")) || [];
    const reportDateInput = document.getElementById("reportDate");
    const displayDate = document.getElementById("displayDate");
    const reportBody = document.getElementById("reportBody");
    const TOTAL_ATTENDENCE = document.getElementById("TOTAL_ATTENDENCE");
    const searchBar = document.getElementById("searchBar");

    // Default date = today
    const today = new Date().toISOString().split("T")[0];
    reportDateInput.value = today;

    reportDateInput.addEventListener("change", renderReport);
    searchBar.addEventListener("input", renderReport);

    function renderReport() {
      const date = reportDateInput.value;
      const searchText = searchBar.value.toLowerCase();
      displayDate.textContent = date;
      reportBody.innerHTML = "";

      let presentCount = 0;
      let absentCount = 0;

      students.forEach(student => {
        if (!student.name.toLowerCase().includes(searchText)) return; // filter search

        const row = document.createElement("tr");

        // Student name
        const nameCell = document.createElement("td");
        nameCell.textContent = student.name;
        row.appendChild(nameCell);

        // Attendance for selected date
        const statusCell = document.createElement("td");
        const status = student.attendance?.[date] || "Absent";
        statusCell.textContent = status;
        statusCell.className = status.toLowerCase();
        row.appendChild(statusCell);

        // Monthly attendance %
        const month = date.slice(0, 7); // YYYY-MM
        let totalDays = 0;
        let presentDays = 0;

        if (student.attendance) {
          for (let day in student.attendance) {
            if (day.startsWith(month)) {
              totalDays++;
              if (student.attendance[day] === "Present") presentDays++;
            }
          }
        }

        const percentage = totalDays > 0 ? ((presentDays / totalDays) * 100).toFixed(2) : "0.00";

        const percentCell = document.createElement("td");
        percentCell.textContent = percentage + "%";

        // Mark red if below 75%
        if (percentage < 75) {
          percentCell.classList.add("low-attendance");
        }

        row.appendChild(percentCell);

        // Update totals
        if (status === "Present") presentCount++;
        else absentCount++;

        reportBody.appendChild(row);
      });

      TOTAL_ATTENDENCE.innerText =
        `Total Students: ${students.length}\n` +
        `Present: ${presentCount}\n` +
        `Absent: ${absentCount}`;
    }

    renderReport();
  </script>
</body>
</html>

